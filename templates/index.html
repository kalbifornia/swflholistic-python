<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8' />
    <title>SWFL Holistic Resources (WAPF Naples Chapter Resources)</title>
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <script src="{{url_for('static',filename='script/jquery.min.js')}}"></script>
    <script src="{{url_for('static',filename='script/wapf.js')}}"></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    <link rel="icon" type="image/png" href="{{url_for('static',filename='wapf-favicon.png')}}">
    <link href="{{url_for('static',filename='css/wapf-naples.css')}}" rel='stylesheet' />
  </head>
  <body>
    <div class="divMainHeader center">
      <h1>SWFL Holistic Resources</h1>
    </div>
    <div id="map" class="divMap">
      <!-- Will be filled in by JavaScript -->
    </div>
    <div id="directory" class="divDirectory">
      <h2 class="center"><a href="#directory">Directory</a></h2>
      <p class="">Note: This directory was initially created for the <a href="https://westonaprice.org">Weston A. Price Foundation</a> - Naples chapter</p>
      <div id="farmingCategory" class="divParentCategory">
      </div>
      <div id="healingArtsCategory" class="divParentCategory">
      </div>
      <div id="foodCategory" class="divParentCategory">
      </div>
      <div id="otherCategory" class="divParentCategory">
      </div>
    </div>

    <script>
    // The value for 'accessToken' begins with 'pk...'
    mapboxgl.accessToken = 'pk.eyJ1Ijoia2FsYmlmb3JuaWEiLCJhIjoiY2w1MXBoczRkMDRjazNjbjlhandjZ3ZpciJ9.mjBOUTv1mm-zgQ2rvUlRvQ';
    var naplesCenterCoordinates = [-81.794294, 26.142198];
    var geoJsonData = null;
    var isGeoJsonLoaded = false;
    var foodFeatures = [];
    var farmingFeatures = [];
    var healingArtsFeatures = [];
    var otherFeatures = [];

    const map = new mapboxgl.Map({
      container: 'map',
      // Replace YOUR_STYLE_URL with your style URL.
      style: 'mapbox://styles/mapbox/streets-v11',
      center: naplesCenterCoordinates,
      zoom: 6.5
    });

    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl());

    const directory = $("#directory");

    function buildCategoryFromFeatures(categoryDivSelector,features) {
      var primaryTags = getPrimaryTags(features);
      for (const primaryTag of primaryTags) {
      $(categoryDivSelector).append(`
          <div id="category-${primaryTag}" class="divPrimaryTag"><h3>${getTagDescription(geoJsonData,primaryTag).plural_description}</h3></div>
        `);
      }

      for (const feature of features) {
        tagURLs = [];
        for (const tag of feature.properties.tags) {
          var tagURL = `<a href="viewtag.html?tag=${tag}">${getTagDescription(geoJsonData,tag).description}</a>`;
          tagURLs.push(tagURL);
        }

        var phoneParagraph = "";
        if (feature.properties.phone != null) {
          phoneParagraph = `<p>${feature.properties.phone}</p>`;
        }

        $(`#category-${feature.properties.primary_tag}`).append(`
          <div class="divDirectoryItem"><p class="divDirectoryItemName"><a href="viewdetails.html?short_name=${feature.properties.short_name}">${feature.properties.name}</a></p>
          <p>${feature.properties.description}</p>
          <p>${feature.properties.address}</p>
          <button class="button-view-on-map" id="button-view-on-map-${feature.properties.short_name}" type="button">View on Map</button>
          ${phoneParagraph}
          <p><strong>Why is this on the WAPF list?</strong> ${feature.properties.why_on_wapf_list}</p>
          <p>Tagged as: ${tagURLs.join(", ")}</p>
          `);
        $(`#button-view-on-map-${feature.properties.short_name}`).click(function() {
          $('html, body').animate({
              scrollTop: $("#map").offset().top
          }, 200);

        map.flyTo({
          center: feature.geometry.coordinates,
          essential: false,
          zoom: 15
          });
        });
      }
    }

    function populateMapWithMarkers() {
      for (const feature of geoJsonData.features) {
        const el = document.createElement("div");

        if (feature.properties.primary_tag == "farm") {
          el.className = "marker marker-farm";
        } else {
          el.className = "marker marker-default";
        }

        tagURLs = [];
        for (const tag of feature.properties.tags) {
          var tagURL = `<a href="viewtag.html?tag=${tag}">${getTagDescription(geoJsonData,tag).description}</a>`;
          tagURLs.push(tagURL);
        }

        var htmlToDisplay = `<h3>${feature.properties.name}</h3>
        <p>${feature.properties.address}</p>
        <p>Tagged as: ${tagURLs.join(", ")}</p>
        <button class="button-view-details" id="button-view-details-${feature.properties.short_name}">View Details</button>`;
        $(document).on('click', `#button-view-details-${feature.properties.short_name}`, function() {
          window.location.href="./viewdetails.html?short_name=" + feature.properties.short_name;
        });

        new mapboxgl.Marker(el)
          .setLngLat(feature.geometry.coordinates)
          .setPopup(
            new mapboxgl.Popup({maxWidth: "300px"})
              .setHTML(htmlToDisplay)
          ).addTo(map);
        }
    }

    function populateDirectory() {
      for (const feature of geoJsonData.features) {
        if (feature.properties.enabled == true) {
          const parentCategory = getTagParentCategory(geoJsonData,feature.properties.primary_tag);
          if (parentCategory == "food") {
            foodFeatures.push(feature);
          } else if (parentCategory == "farming") {
            farmingFeatures.push(feature);
          } else if (parentCategory == "healing_arts") {
            healingArtsFeatures.push(feature);
          } else if (parentCategory == "other") {
            otherFeatures.push(feature);
          }
        }
      }
      buildCategoryFromFeatures("#foodCategory",foodFeatures);
      buildCategoryFromFeatures("#farmingCategory",farmingFeatures);
      buildCategoryFromFeatures("#healingArtsCategory",healingArtsFeatures);
      buildCategoryFromFeatures("#otherCategory",otherFeatures);
    }

    map.on('load', () => {
      var headers = new Headers();
      headers.append("pragma","no-cache");
      headers.append("cache-control","no-cache");

      var options = {
        method: "GET",
        headers: headers
      };

      var request = new Request("{{url_for('static',filename='/json/new_json.json')}}");

      fetch(request,options)
        .then(response => response.json())
        .then(data => {
          geoJsonData = data;
          isGeoJsonLoaded = true;
          map.addSource('wapf-naples-source', {
            type: 'geojson',
            data: geoJsonData
          });

          populateMapWithMarkers();
          populateDirectory();
        });
      });

    </script>
  </body>
</html>
