{% extends 'holistic/base.html' %}

{%block title %}New Holistic Resource{% endblock %}

{%block additional_css %}
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
  <link href="{{url_for('static',filename='css/selectize.bootstrap5.css')}}" rel="stylesheet" />
{% endblock %}
{%block additional_js %}
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
  <script src="{{url_for('static',filename='script/selectize.js')}}"></script>
{% endblock %}

{%block content %}

  <div class="new-feature-content">

    <h1>New Holistic Resource</h1>

    <div class="new-feature-input">
      <label for="input-name">Name*</label>
      <input id="input-name" />
    </div>

    <div class="new-feature-input">
      <label for="input-short-name">Short Name <span class="smallText">(used for generating URL... this will be auto-generated if you don't enter one)</span></label>
      <input id="input-short-name" />
    </div>

  <div class="new-feature-input">
    <label for="input-description">Description*</label>
    <textarea id="input-description" rows="3" /></textarea>
  </div>

  <div class="new-feature-input">
    <label for="input-why-on-wapf-list" type="textarea">Why this belongs on WAPF list*</label>
    <textarea id="input-why-on-wapf-list" rows="3"></textarea>
  </div>

  <div class="new-feature-input">
    <label for="input-address">Address*</label>
    <input id="input-address"/>
  </div>

  <div class="new-feature-input">
    <label for="input-phone">Phone Number</label>
    <input id="input-phone"/>
  </div>

  <div class="new-feature-input">
    <label for="input-url">URL</label>
    <input id="input-url"/>
  </div>

  <div class="new-feature-input">
    <label for="select-areas">Area(s) this Resource is in*</label>
    <select id="select-areas" multiple>
      {% for area in all_areas %}
      <option value="{{area.short_name}}">{{area.short_display_name}} ({{area.wapf_chapter_name}})</option>
      {% endfor %}
    </select>
  </div>

  <div class="new-feature-input">
    <label for="select-primary-tag">Primary Tag for this Resource*</label>
    <select id="select-primary-tag">
      <option value="" disabled selected></option>
      {% for tag in all_tags %}
      <option value="{{tag.tag_name}}">{{tag.description}}</option>
      {% endfor %}
    </select>
  </div>

  <div class="new-feature-input">
    <label for="select-tags">All Tags for this Resource*</label>
    <select id="select-tags" multiple>
      {% for tag in all_tags %}
      <option value="{{tag.tag_name}}">{{tag.description}}</option>
      {% endfor %}
    </select>
  </div>

  <div class="new-feature-input">
    <button class="standard-button" id="button-add-feature">Add Holistic Resource</button>
  </div>

  <div id="div-loading-details" class="loading-details">
  </div>

  <div id="div-error-details" class="error-details invisible">
  </div>

  <div id="div-success-details" class="success-details invisible">
  </div>

<script>

  function validateURL(url) {
    return /^(?:(?:(?:https?|ftp):)?\/\/)(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})).?)(?::\d{2,5})?(?:[/?#]\S*)?$/i.test( url );
  }

  function validateInputs() {
    if ($('#input-name').val().length == 0) {
      alert("Please enter a Name value.");
      $('#input-name').focus();
      return false;
    }

    if ($('#input-name').val().length > 100) {
      alert("Please enter a Name value with a length of 100 characters or less.");
      $('#input-name').focus();
      return false;
    }

    if ($('#input-short-name').val().length > 20) {
      alert("Please enter a Short Name value with a length of 20 characters or less (or leave the field blank and the Short Name will be autogenerated.");
      $('#input-name').focus();
      return false;
    }

    if ($('#input-short-name').val().includes(" ")) {
      alert("Please enter a Short Name value with no spaces. This gets used for URL generation; it cannot have spaces.");
      $('#input-short-name').focus();
      return false;
    }

    if ($('#input-description').val().length == 0) {
      alert("Please enter a Description value.");
      $('#input-short-name').focus();
      return false;
    }

    if ($('#input-description').val().length > 1000) {
      alert("Please enter a Description value with 1000 characters or less.");
      $('#input-description').focus();
      return false;
    }

    if ($('#input-why-on-wapf-list').val().length == 0) {
      alert("Please enter a \"Why this belongs on WAPF list\" value.");
      $('#input-why-on-wapf-list').focus();
      return false;
    }

    if ($('#input-why-on-wapf-list').val().length > 1000) {
      alert("Please enter a \"Why this belongs on WAPF list\" value with 1000 characters or less.");
      $('#input-why-on-wapf-list').focus();
      return false;
    }

    if ($('#input-address').val().length == 0) {
      alert("Please enter an Address value.");
      $('#input-address').focus();
      return false;
    }

    if ($('#input-address').val().length > 200) {
      alert("Please enter an Address value with 200 characters or less.");
      $('#input-address').focus();
      return false;
    }

    let phone = $('#input-phone').val();

    if (phone.length > 30) {
      alert("Please enter a Phone value with 30 characters or less.");
      $('#input-phone').focus();
      return false;
    }

    let pattern = /^(([-]|[0-9])+)$/gmi;
    let result = phone.match(pattern);
    if (phone.length > 0 && result == null) {
      alert("Please enter a Phone value using only digits (0-9) and dashes (-)");
      $('#input-phone').focus();
      return false;
    }

    var url = $('#input-url').val();
    if (url.length > 0 && !validateURL(url)) {
      alert("Please either enter a valid URL or leave the field blank.");
      $('#input-url').focus();
      return false;
    }

    const tags = $('#select-tags').val();
    if (tags == null || tags.length == 0) {
      alert("Please select at least one tag to properly categorize this resource.");
      $('#select-tags').focus();
      return false;
    }

    const primaryTag = $('#select-primary-tag').val();
    if (primaryTag == null || primaryTag.length == 0) {
      alert("Please select a Primary Tag for this resource.");
      $('#select-primary-tag').focus();
      return false;
    }

    console.log(tags);
    console.log(primaryTag);
    var isPrimaryTagInTags = false;
    for (indx in tags) {
      if (tags[indx] == primaryTag) {
        isPrimaryTagInTags = true;
        break;
      }
    }

    if (!isPrimaryTagInTags) {
      alert("Please select a Primary Tag which is also in the overall list of All Tags for this Resouce.");
      $('#select-primary-tag').focus();
      return false;
    }

    const areas = $('#select-areas').val();
    if (areas == null || areas.length == 0) {
      alert("Please select at least one Area this Resource is in.");
      $('#select-areas').focus();
      return false;
    }

    return true;
  }

  function addFeature() {
    $('#div-success-details').empty();
    $('#div-error-details').empty();
    if (validateInputs()) {
      $('#div-loading-details').empty();
      $('#div-loading-details').append("Loading your feature into the system...");
      //get longitude and latitude
      fetch("https://api.mapbox.com/geocoding/v5/mapbox.places/" + $('#input-address').val() + ".json?limit=1&proximity=ip&types=place%2Cpostcode%2Caddress&access_token=pk.eyJ1Ijoia2FsYmlmb3JuaWEiLCJhIjoiY2w1NTVyaWJiMTJ0ZjNtbzM3eW5kYTZuaSJ9.Uo8fTtCdrHQc9C5ibBbPUg",
        {
          "method":"GET"
        }
      )
      .then(response => response.json())
      .then(result => {
        var longitude = 0.0;
        var latitude = 0.0;

        try {
          longitude = parseFloat(result["features"][0]["geometry"]["coordinates"][0]);
          latitude = parseFloat(result["features"][0]["geometry"]["coordinates"][1]);
          console.log("longitude = " + longitude);
          console.log("latitude = " + latitude);
          var address = $('#input-address').val();
          var mapboxAddress = result["features"][0]["place_name"];

          var answer = confirm("The address you entered (" + address + ") was searched online, which converted it to this address to find it on the map:\r\n\r\n" + mapboxAddress + "\r\n\r\nHit OK to accept this address for map location purposes, or Cancel to change it.");
          if (!answer) {
            $('#div-loading-details').empty();
            $('#input-address').focus();
            return;
          }
        } catch (e) {
          console.error(e);
          alert("Could not get find a valid address or latitude/longitude based on input address of: " + $('#input-address').val() + ".\r\n\r\nPlease enter a new address for this Resource.");
          return;
        }
        addFeatureToDatabase(longitude,latitude);
      });
    }
  }

  function clearOutInputFields() {
    $('#input-name').val("");
    $('#input-short-name').val("");
    $('#input-description').val("");
    $('#input-why-on-wapf-list').val("");
    $('#input-address').val("");
    $('#input-phone').val("");
    $('#input-url').val("");
    $('#select-tags')[0].selectize.clear();
    $('#select-primary-tag')[0].selectize.clear();
    $('#select-areas')[0].selectize.clear();
  }

  function addFeatureToDatabase(longitude,latitude) {

    addFeaturePayload = {
      name: $('#input-name').val(),
      short_name: $('#input-short-name').val(),
      enabled: false,
      description: $('#input-description').val(),
      why_on_wapf_list: $('#input-why-on-wapf-list').val(),
      longitude: longitude,
      latitude: latitude,
      address: $('#input-address').val(),
      phone: $('#input-phone').val(),
      url: $('#input-url').val(),
      primary_tag: $('#select-primary-tag').val(),
      type: "Point",
      tags: $('#select-tags').val(),
      areas: $('#select-areas').val()
    };
    addFeatureJSON = JSON.stringify(addFeaturePayload);
    fetch("/holistic/api/feature", {
      "method": "POST",
      "headers": {"Content-Type": "application/json"},
      "body": addFeatureJSON
    })
    .then((response) => {
      if (response.ok) {
        var responseJson = response.json();
        return responseJson;
      }
      return Promise.reject(response);
    })
    .then((responseJson) => {
      console.log(responseJson);
      $('#div-loading-details').empty();
      $('#div-success-details').empty();
      $('#div-success-details').removeClass("invisible");
      $('#div-success-details').append(`Successfully added feature to database with short_name identifier <strong>${responseJson["short_name"]}</strong>. To avoid spam, the site developer (Joe) will have to confirm the entry before it starts showing up in the map and directory. Thank you for your addition to the Holistic directory!`);
      $('#div-error-details').empty();
      $('html, body').animate({
        scrollTop: $("#div-success-details").offset().top
      }, 1000);
      clearOutInputFields();
    })
    .catch((response) => {
      response.json().then((json) => {
        $('#div-loading-details').empty();
        $('#div-error-details').removeClass("invisible");
        console.log(json["error_message"]);
        $('#div-error-details').empty();
        $('#div-error-details').append(`Technical error returned from server: ${json["error_message"]}<br /><br />Please report this to the developer, joekalb (at) protonmail (dot) com to look into.`);
        return;
      }).catch((response) => {
        //Catching the non-JSON error response case
        $('#div-loading-details').empty();
        $('#div-error-details').empty();
        $('#div-error-details').append(`Technical error returned from server. Technical note: This was NOT a JSON error response.<br /><br />Please report this to the developer, joekalb (at) protonmail (dot) com to look into.`);
        alert("Catching the non-JSON error response case. " + response);
      });
    });
  }
  $('#button-add-feature').click(addFeature);

  var selectTags = $('#select-tags').selectize({
    plugins: ["remove_button"],
    create: false,
    sortField: 'text',
    selectOnTab: false,
  });

  $('#select-primary-tag').selectize({
    create: false,
    sortField: 'text',
    onChange: function(value, isOnInitialize) {
        var selectTagsVal = $('#select-tags').val();
        if (selectTagsVal == null || selectTagsVal.length == 0) {
          $('#select-tags')[0].selectize.setValue([value]);
        }
    }
  });

  $('#select-areas').selectize({
    plugins: ["remove_button"],
    create: false,
    sortField: 'text',
    selectOnTab: false
  });
</script>
{% endblock %}
